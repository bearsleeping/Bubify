<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Bubfiy</title>

<!-- Import czcionki z Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

<!-- Ustawienia dla aplikacji webowej na iOS (ukrycie paska przeglądarki) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Bubify">
<link rel="apple-touch-icon" href="images/apple-touch-icon.png"> <!-- Zastąp ścieżką do Twojej ikony (np. 180x180px) -->

<style>
:root {
    --bg-color: #121212;
    --primary: #ffffff;
    --primary-hover: #e0e0e0;
    --text-primary: #ffffff;
    --text-secondary: #b3b3b3;
    --control-bg: #282828;
    --card-bg: #181818;
}

/* Gothic Vampire Theme */
body.theme-vampire {
    --bg-color: #121212;
    --primary: #ffffff;
    --primary-hover: #e0e0e0;
    --text-primary: #ffffff;
    --text-secondary: #b3b3b3;
    --control-bg: #282828;
    --card-bg: #181818;
}
* { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; /* Usunięcie podświetlenia przy dotyku na iOS */ }
body {
    background-color: var(--bg-color); color: var(--text-primary);
    max-width:400px; margin:0 auto;
    height: 100vh; /* Fallback dla przeglądarek bez JS */
    height: calc(var(--vh, 1vh) * 100); /* Poprawka na problem 100vh na mobile */
    display:flex; flex-direction:column;
    overflow:hidden; position:relative; transition: transform 0.3s ease-in-out, background-color 0.3s ease, color 0.3s ease;
}
/* Wrappery dla układu desktopowego - na mobile zachowują się jakby ich nie było */
.now-playing-left, .now-playing-center, .now-playing-right {
    display: contents;
}
.header { padding:15px 20px; display: flex; justify-content: space-between; align-items: center; font-size:18px; font-weight:600; letter-spacing:-0.5px; transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
.header > span {
    font-family: 'Pacifico', cursive;
    font-size: 24px;
    font-weight: 400; /* Czcionki ozdobne często wyglądają lepiej bez pogrubienia */
    transform: translateY(2px); /* Delikatne dopasowanie pionowe */
}
.theme-switcher {
    cursor: pointer;
    color: var(--text-secondary);
    transition: color 0.2s, transform 0.1s ease-out;
}
.theme-switcher:hover {
    color: var(--text-primary);
}
.theme-switcher:active {
    transform: scale(0.9);
}
.now-playing { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:0 30px; transition: transform 0.3s ease-in-out; z-index: 20; }
.album-cover { width:280px; height:280px; border-radius:50%; box-shadow:0 4px 30px rgba(0,0,0,0.5); position:relative; margin-bottom:30px; background:#1a1a1a; display:flex; align-items:center; justify-content:center; background-image: repeating-radial-gradient(circle at center, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 4px); cursor: grab; transition: box-shadow 0.7s ease-in-out; order: 1; }
.album-cover::before { content:''; position:absolute; width:20px; height:20px; background:var(--bg-color); border-radius:50%; z-index:2; border:3px solid var(--control-bg); transition: background-color 0.3s ease, border-color 0.3s ease; }
.album-cover img { width:100px; height:100px; object-fit:cover; border-radius:50%; z-index:1; }
.song-info { text-align:center; margin-bottom:30px; width:100%; order: 2; }
.song-title { font-size:22px; font-weight:600; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.song-artist { font-size:16px; color:var(--text-secondary); transition: color 0.3s ease; }
.progress-container { width:100%; margin-bottom:15px; display: flex; flex-wrap: wrap; justify-content: space-between; order: 3; }
.progress-bar {
    width: 100%;
    height: 5px; /* Zwiększony obszar dotykowy dla łatwiejszej obsługi */
    background-color: transparent;
    margin-bottom: 5px;
    cursor: pointer;
    position: relative; /* Potrzebne dla pseudo-elementu i paska postępu */
    order: 1;
}
/* Rysowanie tła (ścieżki) jako pseudo-element, aby nie kolidowało z obszarem dotykowym */
.progress-bar::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 100%;
    height: 3px;
    background-color: var(--control-bg); transition: background-color 0.3s ease;
    border-radius: 3px;
    pointer-events: none; /* Ignoruj zdarzenia myszy na tym elemencie */
}
.progress {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    height: 3px; /* Stała wysokość wizualnego paska */
    background-color: var(--primary);
    border-radius: 3px;
    width: 0%; 
    transition: width 0.1s linear, background-color 0.3s ease;
    pointer-events: none; /* Ignoruj zdarzenia myszy na tym elemencie */
}
.time-text { font-size:12px; color:var(--text-secondary); transition: color 0.3s ease; }
#current-time { order: 2; }
#duration { order: 3; }
.volume-container {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 25px;
    order: 4;
}
.volume-container svg {
    fill: var(--text-secondary);
    flex-shrink: 0; transition: fill 0.3s ease;
}
.volume-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 24px; /* Zwiększona wysokość dla łatwiejszej interakcji na dotyku */
    background: transparent; /* Tło jest teraz na ścieżce */
    outline: none;
    cursor: pointer;
}
.volume-slider::-webkit-slider-runnable-track {
    width: 100%;
    height: 3px; /* Bardzo cienka ścieżka w stylu iOS */
    cursor: pointer;
    background: linear-gradient(to right, var(--text-primary) var(--volume-progress, 100%), var(--control-bg) var(--volume-progress, 100%));
    border-radius: 2px;
}
.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 15px; /* Przywrócenie kciuka dla interaktywności */
    height: 15px;
    background: var(--text-primary);
    border-radius: 50%;
    cursor: pointer;
    margin-top: -6px; /* Wyśrodkowanie kciuka na ścieżce (3px - 15px) / 2 */ 
    transition: transform 0.15s ease-in-out, background-color 0.3s ease;
}
.volume-slider:active::-webkit-slider-thumb {
    transform: scale(1.2); /* Powiększenie kciuka podczas przeciągania */
}

/* Style dla Firefox */
.volume-slider::-moz-range-track {
    width: 100%;
    height: 3px;
    cursor: pointer;
    background: var(--control-bg);
    border-radius: 2px;
}
.volume-slider::-moz-range-progress {
    background-color: var(--text-primary);
    height: 3px;
    border-radius: 2px;
}
.volume-slider::-moz-range-thumb {
    width: 15px;
    height: 15px;
    background: var(--text-primary);
    border-radius: 50%;
    cursor: pointer;
    border: none; 
    transition: transform 0.15s ease-in-out, background-color 0.3s ease;
}
.volume-slider:active::-moz-range-thumb {
    transform: scale(1.2);
} /* Wielkość przycisków to 18px */
.controls { display:flex; justify-content:center; align-items:center; gap: 18px; margin-bottom:30px; order: 5; }
.control-btn { width:48px; height:48px; display:flex; align-items:center; justify-content:center; border-radius:50%; cursor:pointer; background-color: rgba(255,255,255,0.1); transition: background-color 0.2s, transform 0.1s ease-out; }
.control-btn:hover { background-color: rgba(255,255,255,0.2); }
.control-btn:active {
    transform: scale(0.9);
    background-color: rgba(255,255,255,0.15);
}
.control-btn svg { fill: var(--text-primary); transition: fill 0.3s ease; }
.control-btn.active svg { fill: var(--primary); }
.repeat-btn .icon-repeat-one { display: none; }
.favorite-control-btn .icon-heart-filled { display: none; }
.favorite-control-btn.is-favorite .icon-heart-empty { display: none; }
.favorite-control-btn.is-favorite .icon-heart-filled { display: block; fill: var(--primary); }
.control-btn .icon-heart-empty { fill: none; }
.play-btn { width:70px; height:70px; background-color: var(--primary); transition: background-color 0.3s ease, transform 0.1s ease-out; }
#favorite-player-btn { display: none; }
.play-btn svg { fill: var(--bg-color); }
.play-btn .icon-pause { display: none; } 
.play-btn:hover { background-color: var(--primary-hover); }
.playing .play-btn .icon-play {
    display: none;
}
.playing .play-btn .icon-pause {
    display: block;
}
.player-footer { background-color:var(--card-bg); border-top-left-radius:35px; border-top-right-radius:15px; box-shadow:0 -5px 15px rgba(0,0,0,0.3); position:absolute; bottom:0; left:0; right:0; transform: translateY(calc(100% + 20px)); transition: transform 0.3s ease-in-out, background-color 0.3s ease; display: flex; flex-direction: column; max-height: 520px; overflow-y: auto; }
.player-footer { background-color:var(--card-bg); border-radius: 0; box-shadow:0 -5px 15px rgba(0,0,0,0.3); position:absolute; bottom:0; left:0; right:0; transform: translateY(calc(100% + 20px)); transition: transform 0.3s ease-in-out, background-color 0.3s ease; display: flex; flex-direction: column; max-height: 520px; overflow-y: auto; }
.search-container {
    padding: 20px 20px 10px 20px;
    flex-shrink: 0;
    position: sticky;
    top: 0;
    z-index: 50;
    background-color: rgba(24, 24, 24, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
}
.search-wrapper {
    position: relative;
    width: 100%;
}
.search-input {
    width: 100%;
    background-color: var(--control-bg);
    border: 1px solid transparent;
    border-radius: 20px;
    padding: 10px 15px 10px 40px;
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    transition: background-color 0.2s, border-color 0.2s;
}
.search-input:focus {
    background-color: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.1);
}
.search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    fill: var(--text-secondary);
    width: 18px;
    height: 18px;
    pointer-events: none;
}
.playlist-header { padding: 15px 20px; display: flex; align-items: center; border-bottom: 1px solid var(--control-bg); flex-shrink: 0; gap: 15px; }
.playlist-cover-container {
    width: 60px; height: 60px;
    background-color: #333;
    border-radius: 4px;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.playlist-cover-img { width: 100%; height: 100%; object-fit: cover; }
.playlist-cover-overlay {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0,0,0,0.6);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.2s;
    cursor: pointer;
}
.playlist-cover-overlay svg { fill: #fff; width: 24px; height: 24px; margin-bottom: 4px; }
.playlist-cover-overlay span { color: #fff; font-size: 10px; font-weight: 600; text-transform: uppercase; }
.playlist-cover-container:hover .playlist-cover-overlay { opacity: 1; }

.playlist-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
.playlist-type { font-size: 12px; text-transform: uppercase; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; display: none; }
.playlist-title-container { display: flex; align-items: center; gap: 10px; width: 100%; }
.playlist-title { font-size: 18px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; }
.playlist-description { color: var(--text-secondary); font-size: 14px; margin-top: 8px; display: none; }

.manage-playlists-btn { background: none; border: 1px solid var(--text-secondary); color: var(--text-secondary); padding: 5px 10px; border-radius: 15px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px; transition: all 0.2s; }
.manage-playlists-btn { background: none; border: 1px solid var(--text-secondary); color: var(--text-secondary); padding: 4px 10px; border-radius: 15px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 12px; transition: all 0.2s; align-self: flex-start; margin-top: 5px; }
.manage-playlists-btn:hover { background-color: var(--control-bg); color: var(--text-primary); border-color: var(--control-bg); }
.manage-playlists-btn svg { fill: currentColor; width: 16px; height: 16px; }
.song-list { list-style:none; padding: 0 20px 35px; }
.song-item { display:flex; align-items:center; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1); transition:background-color 0.2s; gap: 15px; }
.song-item:hover { background-color: rgba(255,255,255,0.05); }
.song-item:last-child { border-bottom:none; }
.song-number { color:var(--text-secondary); font-size:14px; width:30px; text-align:center; }
.song-thumbnail { width:40px; height:40px; border-radius:5px; overflow:hidden; margin-right:15px; }
.song-thumbnail img { width:100%; height:100%; object-fit:cover; }
.song-item-info { flex:1; cursor: pointer; min-width: 0; }
.song-item-title { font-size:15px; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; transition: color 0.3s ease; }
.song-item-artist { font-size:13px; color:var(--text-secondary); }
.song-item.active .song-item-title {
    color: var(--primary);
}
.song-item-duration { font-size:13px; color:var(--text-secondary); margin-left: 15px; }
.song-item-actions {
    margin-left: auto;
    padding-left: 10px;
    display: flex;
    align-items: center;
}
.favorite-btn { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; }
.favorite-btn svg { stroke: var(--text-secondary); fill: none; transition: all 0.2s; }
.favorite-btn:hover svg { stroke: var(--primary); }
.favorite-btn .icon-heart-filled { display: none; }
.favorite-btn.is-favorite .icon-heart-empty { display: none; }
.favorite-btn.is-favorite .icon-heart-filled { display: block; fill: var(--primary); }
.player-footer::-webkit-scrollbar { width:5px; }
/* Drag & Drop styles */
.song-item[draggable="true"] { cursor: grab; }
.song-item.dragging { opacity: 0.5; background-color: rgba(255, 255, 255, 0.1); border: 1px dashed var(--text-secondary); }
.song-item.drag-over { border-top: 2px solid var(--primary); }
.more-options-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.more-options-btn svg {
    fill: var(--text-secondary);
    transition: fill 0.2s;
}
.more-options-btn:hover svg { fill: var(--text-primary); }
.player-footer::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius:10px; }
.player-footer::-webkit-scrollbar-thumb { background:var(--text-secondary); border-radius:10px; }
@media (max-height:700px) { .album-cover { width:220px; height:220px; } }

/* Nowe style do animacji wysuwania kolejki */
body.queue-open .header {
    transform: translateY(-100%);
    opacity: 0;
    pointer-events: none;
}
body.queue-open .player-footer {
    transform: translateY(0);
}
body.queue-open .now-playing {
    transform: translateY(-520px);
}
body.scrubbing {
    cursor: grabbing;
}

/* Ukrywanie suwaka głośności tylko na urządzeniach z systemem iOS */
body.is-ios .volume-container {
    display: none;
}

/* Efekt specjalny dla Type O Negative */
.album-cover.type-o-negative-glow {
    box-shadow: 0 4px 35px rgba(0,0,0,0.6), 0 0 80px 15px rgba(80, 220, 0, 0.5);
}

/* Efekt specjalny dla Rammstein */
.album-cover.rammstein-glow {
    box-shadow: 0 4px 35px rgba(0,0,0,0.6), 0 0 80px 15px rgba(255, 0, 0, 0.5);
}

/* Playlist Manager View */
.playlist-manager-view {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--bg-color);
    z-index: 110; /* Above lyrics view */
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: flex;
    flex-direction: column;
}
body.playlist-manager-open .playlist-manager-view {
    transform: translateY(0);
}
.playlist-manager-header {
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    flex-shrink: 0;
    border-bottom: 1px solid var(--control-bg);
}
.playlist-manager-list {
    list-style: none;
    padding: 10px;
    overflow-y: auto;
}
.playlist-manager-item {
    padding: 15px 20px;
    font-size: 18px;
    border-bottom: 1px solid var(--control-bg);
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.playlist-manager-cover {
    width: 40px; height: 40px;
    border-radius: 4px;
    margin-right: 12px;
    object-fit: cover;
    background-color: #333;
    flex-shrink: 0;
}
.playlist-manager-header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}
.create-playlist-btn, .close-playlist-manager-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}
.create-playlist-btn svg, .close-playlist-manager-btn svg {
    fill: var(--text-secondary);
    transition: fill 0.2s;
}
.create-playlist-btn:hover svg, .close-playlist-manager-btn:hover svg {
    fill: var(--text-primary);
}
.delete-playlist-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s, background-color 0.2s;
}
.playlist-manager-item:hover .delete-playlist-btn {
    opacity: 1;
}
.delete-playlist-btn svg {
    width: 18px;
    height: 18px;
    fill: var(--text-secondary);
    transition: fill 0.2s;
}
.delete-playlist-btn:hover {
    background-color: rgba(255, 69, 58, 0.15);
}
.delete-playlist-btn:hover svg {
    fill: #ff453a; /* iOS red */
}
.playlist-manager-item:hover {
    background-color: rgba(255,255,255,0.05);
}
.playlist-manager-item.active {
    color: var(--primary);
    font-weight: 600;
}

/* Add to Playlist View */
.add-to-playlist-view {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--bg-color);
    z-index: 120; /* Above other views */
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: flex;
    flex-direction: column;
}
body.add-to-playlist-open .add-to-playlist-view {
    transform: translateY(0);
}
.add-to-playlist-header {
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    flex-shrink: 0;
    border-bottom: 1px solid var(--control-bg);
}
.close-add-to-playlist-btn {
    cursor: pointer;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.close-add-to-playlist-btn svg { fill: var(--text-secondary); transition: fill 0.2s; }
.close-add-to-playlist-btn:hover svg { fill: var(--text-primary); }
.add-to-playlist-list {
    list-style: none;
    padding: 10px;
    overflow-y: auto;
}
.add-to-playlist-item {
    padding: 15px 20px;
    font-size: 18px;
    border-bottom: 1px solid var(--control-bg);
    cursor: pointer;
    transition: background-color 0.2s;
}
.add-to-playlist-item:hover { background-color: rgba(255,255,255,0.05); }
.add-to-playlist-item.remove-item { color: #ff453a; }
.add-to-playlist-item.remove-item:hover { background-color: rgba(255, 69, 58, 0.15); }
.desktop-logo { display: none; }

/* Edit Playlist Modal */
.modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex; justify-content: center; align-items: center;
    z-index: 200;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.modal-overlay.open { opacity: 1; pointer-events: auto; }
.modal-content {
    background: var(--control-bg);
    padding: 24px;
    border-radius: 8px;
    width: 90%; max-width: 450px;
    display: flex; flex-direction: column; gap: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.modal-content h3 { font-size: 22px; font-weight: 700; margin-bottom: 0; }
.modal-body { display: flex; gap: 20px; align-items: center; }
.modal-cover-wrapper {
    width: 120px; height: 120px;
    position: relative; flex-shrink: 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    cursor: pointer;
}
.modal-cover-wrapper img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
.modal-cover-edit-overlay {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.2s; border-radius: 4px;
}
.modal-cover-wrapper:hover .modal-cover-edit-overlay { opacity: 1; }
.modal-cover-edit-overlay svg { fill: #fff; width: 32px; height: 32px; }
#edit-modal-name-input {
    background: rgba(255,255,255,0.1);
    border: 1px solid transparent;
    padding: 12px;
    border-radius: 4px;
    color: #fff;
    width: 100%;
    font-size: 16px;
    outline: none;
}
#edit-modal-name-input:focus { background: rgba(255,255,255,0.15); }
.modal-footer { display: flex; justify-content: flex-end; gap: 15px; }
.modal-btn {
    padding: 10px 20px; border-radius: 25px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; letter-spacing: 0.5px;
}
.modal-btn-cancel { background: transparent; color: #fff; }
.modal-btn-cancel:hover { text-decoration: underline; }
.modal-btn-save { background: #fff; color: #000; }
.modal-btn-save:hover { transform: scale(1.04); }
.edit-playlist-btn {
    background: transparent; border: none; cursor: pointer;
    display: none; align-items: center; justify-content: center;
    padding: 5px; border-radius: 50%; transition: background-color 0.2s;
}
.edit-playlist-btn:hover { background-color: rgba(255,255,255,0.1); }
.edit-playlist-btn svg { fill: var(--text-secondary); width: 24px; height: 24px; transition: fill 0.2s; }
.edit-playlist-btn:hover svg { fill: var(--text-primary); }

@media (min-width: 800px) {
    .song-list {
        padding: 0 10px 20px 10px;
    }
}

/* --- STYL DESKTOPOWY (Spotify-like) --- */
@media (min-width: 1024px) {
    body {
        max-width: none;
        height: 100vh;
        display: grid;
        grid-template-columns: 260px 1fr;
        grid-template-rows: 1fr 90px;
        grid-template-areas:
            "sidebar main"
            "player player";
        background-color: #000;
        overflow: hidden;
    }

    /* Ukrycie elementów mobilnych */
    .header { display: none; }
    .queue-btn { display: none; } /* Kolejka/Playlista jest zawsze widoczna */

    /* Sidebar (Lista Playlist) */
    .playlist-manager-view {
        grid-area: sidebar;
        position: relative;
        transform: none;
        background-color: #121212;
        z-index: 5;
        padding: 20px 10px;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #000;
        top: auto; left: auto; right: auto; bottom: auto; /* Reset pozycji mobilnej */
    }
    .desktop-logo {
        display: block;
        font-family: 'Pacifico', cursive;
        font-size: 28px;
        padding: 0 15px 20px;
        text-align: center;
    }
    .playlist-manager-header {
        padding: 0 15px 20px;
        border-bottom: 1px solid #282828;
    }
    .playlist-manager-header span {
        font-size: 16px;
        color: #b3b3b3;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
    }
    .close-playlist-manager-btn { display: none; }
    .playlist-manager-list { padding: 10px 0; }
    .playlist-manager-item {
        padding: 10px 15px;
        font-size: 14px;
        border-bottom: none;
        border-radius: 4px;
        color: #b3b3b3;
    }
    .playlist-manager-item:hover, .playlist-manager-item.active {
        background-color: #282828;
        color: #fff;
    }

    /* Główny widok (Lista utworów) */
    .player-footer {
        grid-area: main;
        position: relative;
        transform: none;
        background: linear-gradient(180deg, #202020 0%, #121212 100%);
        border-radius: 8px;
        margin: 10px 10px 0 0;
        box-shadow: none;
        z-index: 1;
        display: flex;
        flex-direction: column;
        max-height: none;
        overflow-y: auto; /* Umożliwia przewijanie całej sekcji */
        top: auto; left: auto; right: auto; bottom: auto; /* Reset pozycji mobilnej */
    }
    .search-container {
        padding: 20px 30px 10px;
        background-color: rgba(32, 32, 32, 0.8); /* Dopasowanie do górnej części gradientu */
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
    }
    .search-input { border-radius: 4px; }
    .playlist-header {
        background: transparent;
        border-bottom: none;
        padding: 30px 30px 24px;
        align-items: flex-end;
        gap: 24px;
    }
    .playlist-cover-container {
        width: 232px; height: 232px;
        box-shadow: 0 4px 60px rgba(0,0,0,0.5);
    }
    .playlist-cover-overlay svg { width: 48px; height: 48px; margin-bottom: 10px; }
    .playlist-cover-overlay span { font-size: 14px; }
    .playlist-info { display: flex; flex-direction: column; justify-content: flex-end; height: 232px; }
    .playlist-type { display: block; }
    .playlist-title {
        font-size: 72px; /* Duży tytuł jak w Spotify */
        font-weight: 800;
        margin: 0;
        line-height: 1;
    }
    .playlist-title-container { margin-bottom: 10px; align-items: flex-end; }
    .edit-playlist-btn { margin-bottom: 8px; }
    .edit-playlist-btn svg { width: 32px; height: 32px; }
    .manage-playlists-btn { display: none; }
    .song-list { padding: 0 30px 30px; }
    .song-item {
        border-bottom: 1px solid rgba(255,255,255,0.05);
        padding: 8px 10px;
        border-radius: 4px;
    }
    .song-item:hover { background-color: rgba(255,255,255,0.1); }
    .song-item-title { font-size: 16px; }

    /* Pasek odtwarzania (Dół) */
    .now-playing {
        grid-area: player;
        position: relative;
        transform: none;
        background-color: #181818;
        border-top: 1px solid #282828;
        padding: 0 16px;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
    }
    /* Zabezpieczenie przed przesuwaniem paska gdy aktywna jest klasa queue-open */
    body.queue-open .now-playing {
        transform: none !important;
    }

    /* Lewa sekcja: Okładka i Info */
    .now-playing-left { display: flex; align-items: center; width: 30%; min-width: 180px; overflow: hidden; }
    .album-cover {
        width: 56px; height: 56px; margin: 0 15px 0 0;
        border-radius: 4px; background-image: none; box-shadow: none;
        flex-shrink: 0; animation: none !important; transform: none !important;
    }
    .album-cover::before { display: none; }
    .album-cover img { border-radius: 4px; width: 100%; height: 100%; }
    .song-info {
        text-align: left; margin: 0; display: flex; flex-direction: column; justify-content: center; overflow: hidden;
    }
    .song-title { font-size: 14px; margin-bottom: 2px; }
    .song-artist { font-size: 12px; }

    /* Środkowa sekcja: Kontrolki i Pasek */
    .now-playing-center {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        width: 40%; max-width: 722px;
    }
    .controls { margin-bottom: 0; gap: 15px; order: 1; }
    .control-btn { width: 32px; height: 32px; background: transparent; }
    #favorite-player-btn { display: flex; }
    .control-btn:hover { background: transparent; transform: scale(1.1); }
    .control-btn svg { width: 16px; height: 16px; fill: #b3b3b3; }
    .control-btn .icon-heart-empty { fill: none; stroke: #b3b3b3; }
    .control-btn:hover svg { fill: #fff; }
    .control-btn:hover .icon-heart-empty { fill: none; stroke: #fff; }
    .play-btn { width: 32px; height: 32px; background: #fff; border-radius: 50%; transform: scale(1); }
    .play-btn:hover { background: #fff; transform: scale(1.05); }
    .play-btn svg { fill: #000; }
    
    .progress-container {
        display: flex; align-items: center; width: 100%; margin-bottom: 5px; gap: 8px; flex-wrap: nowrap; order: 0;
    }
    .progress-bar { height: 4px; margin-bottom: 0; border-radius: 2px; order: 0; flex-grow: 1; }
    .progress-bar::before { background-color: #4d4d4d; }
    .progress { background-color: #fff; }
    .progress-bar:hover .progress { background-color: var(--primary); }
    #current-time, #duration { order: 0; font-size: 11px; min-width: 35px; text-align: center; }

    /* Prawa sekcja: Głośność */
    .now-playing-right { width: 30%; display: flex; justify-content: flex-end; align-items: center; }
    .volume-container { width: 120px; margin-bottom: 0; }
}
</style>
</head>
<body>
<div class="header">
    <span>Bubify</span>
    <div class="theme-switcher" id="theme-switcher"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></div>
</div>
<div class="now-playing">
    <div class="now-playing-left">
        <div class="album-cover">
            <img src="https://placehold.co/100x100/2c2c2e/ffffff?text=?" alt="Okładka albumu" />
        </div>
        <div class="song-info">
            <div class="song-title">Ładowanie...</div>
            <div class="song-artist">...</div>
        </div>
    </div>

    <div class="now-playing-center">
        <div class="controls">
            <div class="control-btn repeat-btn" id="repeat-btn">
                <svg class="icon-repeat-all" width="24" height="24" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                <svg class="icon-repeat-one" width="24" height="24" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v3H13z"/></svg>
            </div>
            <div class="control-btn prev-btn">
                <svg width="18" height="18" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
            </div>
            <div class="control-btn play-btn" id="play-btn">
                <svg class="icon-play" width="24" height="24" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg class="icon-pause" width="24" height="24" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </div>
            <div class="control-btn next-btn">
                <svg width="18" height="18" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </div>
            <div class="control-btn favorite-control-btn" id="favorite-player-btn">
                <svg class="icon-heart-empty" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                <svg class="icon-heart-filled" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            </div>
            <div class="control-btn queue-btn">
                <svg width="24" height="24" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
            </div>
        </div>
        <div class="progress-container">
            <span id="current-time" class="time-text">0:00</span>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
            <span id="duration" class="time-text">0:00</span>
        </div>
    </div>

    <div class="now-playing-right">
        <div class="volume-container">
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            <input type="range" id="volume-slider" class="volume-slider" min="0" max="100" value="100">
        </div>
    </div>
</div>
<div class="player-footer">
<div class="search-container">
    <div class="search-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        <input type="text" class="search-input" id="search-input" placeholder="Szukaj piosenki...">
    </div>
</div>
<div class="playlist-header">
    <div class="playlist-cover-container" id="playlist-cover-container">
        <img src="https://placehold.co/300x300/333/999?text=B" class="playlist-cover-img" id="playlist-cover-img" alt="Okładka playlisty">
        <div class="playlist-cover-overlay" id="playlist-cover-overlay">
            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            <span>Zmień zdjęcie</span>
        </div>
        <input type="file" id="playlist-cover-input" accept="image/*" style="display:none">
    </div>
    <div class="playlist-info">
        <span class="playlist-type">Playlista</span>
        <div class="playlist-title-container">
            <h2 class="playlist-title">Wszystkie utwory</h2>
            <button class="edit-playlist-btn" id="edit-playlist-btn" title="Edytuj szczegóły">
                <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
        </div>
        <button class="manage-playlists-btn">
            <svg width="24" height="24" viewBox="0 0 24 24"><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>
            <span>Playlisty</span>
        </button>
    </div>
</div>
<ul class="song-list" id="song-list">
</ul>
</div>
<div class="playlist-manager-view">
    <div class="desktop-logo">Bubify</div>
    <div class="playlist-manager-header">
        <span>Wybierz playlistę</span>
        <div class="playlist-manager-header-actions">
            <button class="create-playlist-btn" title="Utwórz nową playlistę">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </button>
            <div class="close-playlist-manager-btn">
                <svg width="24" height="24" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </div>
        </div>
    </div>
    <ul class="playlist-manager-list" id="playlist-manager-list">
    </ul>
</div>
<div class="add-to-playlist-view">
    <div class="add-to-playlist-header">
        <span id="add-to-playlist-title">Dodaj do...</span>
        <div class="close-add-to-playlist-btn">
            <svg width="24" height="24" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </div>
    </div>
    <ul class="add-to-playlist-list" id="add-to-playlist-list">
    </ul>
</div>
<div class="modal-overlay" id="edit-playlist-modal">
    <div class="modal-content">
        <h3>Edytuj szczegóły</h3>
        <div class="modal-body">
            <div class="modal-cover-wrapper" id="edit-modal-cover-wrapper">
                <img id="edit-modal-cover-img" src="" alt="Okładka">
                <div class="modal-cover-edit-overlay">
                    <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                </div>
                <input type="file" id="edit-modal-file-input" accept="image/*" style="display:none">
            </div>
            <input type="text" id="edit-modal-name-input" placeholder="Nazwa playlisty">
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-cancel" id="edit-modal-cancel-btn">Anuluj</button>
            <button class="modal-btn modal-btn-save" id="edit-modal-save-btn">Zapisz</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Poprawka na wysokość 100vh na urządzeniach mobilnych (np. iOS Safari) ---
    function setViewportHeight() {
        // Obliczamy 1% wysokości okna przeglądarki i ustawiamy jako zmienną CSS
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    // Uruchom funkcję na starcie
    setViewportHeight();
    // Uruchom funkcję przy zmianie rozmiaru okna (np. obrót ekranu)
    window.addEventListener('resize', setViewportHeight);

    // --- Wykrywanie iOS i ukrywanie suwaka głośności ---
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (isIOS) {
        document.body.classList.add('is-ios');
    }

    const playBtn = document.getElementById('play-btn');
    const progress = document.getElementById('progress');
    const currentTimeEl = document.getElementById('current-time');
    const durationEl = document.getElementById('duration');
    const songListEl = document.getElementById('song-list');
    const queueBtn = document.querySelector('.queue-btn');
    const body = document.body;
    const themeSwitcher = document.getElementById('theme-switcher');
    const volumeSlider = document.getElementById('volume-slider');
    const albumCover = document.querySelector('.album-cover');
    const progressBar = document.querySelector('.progress-bar');
    const repeatBtn = document.getElementById('repeat-btn');
    const iconRepeatAll = repeatBtn.querySelector('.icon-repeat-all');
    const iconRepeatOne = repeatBtn.querySelector('.icon-repeat-one');
    const playlistTitleEl = document.querySelector('.playlist-title');
    const managePlaylistsBtn = document.querySelector('.manage-playlists-btn');
    const playlistManagerView = document.querySelector('.playlist-manager-view');
    const closePlaylistManagerBtn = document.querySelector('.close-playlist-manager-btn');
    const playlistManagerList = document.getElementById('playlist-manager-list');
    const createPlaylistBtn = document.querySelector('.create-playlist-btn');
    const addToPlaylistView = document.querySelector('.add-to-playlist-view');
    const closeAddToPlaylistBtn = document.querySelector('.close-add-to-playlist-btn');
    const addToPlaylistList = document.getElementById('add-to-playlist-list');
    const addToPlaylistTitle = document.getElementById('add-to-playlist-title');
    const favoritePlayerBtn = document.getElementById('favorite-player-btn');
    const searchInput = document.getElementById('search-input');
    const playlistCoverInput = document.getElementById('playlist-cover-input');
    const playlistCoverOverlay = document.getElementById('playlist-cover-overlay');
    const playlistCoverImg = document.getElementById('playlist-cover-img');
    const editPlaylistBtn = document.getElementById('edit-playlist-btn');
    const editPlaylistModal = document.getElementById('edit-playlist-modal');
    const editModalNameInput = document.getElementById('edit-modal-name-input');
    const editModalCoverImg = document.getElementById('edit-modal-cover-img');
    const editModalFileInput = document.getElementById('edit-modal-file-input');
    const editModalCoverWrapper = document.getElementById('edit-modal-cover-wrapper');
    const editModalCancelBtn = document.getElementById('edit-modal-cancel-btn');
    const editModalSaveBtn = document.getElementById('edit-modal-save-btn');

    let isPlaying = false;
    let currentSongIndex = 0;
    const audio = new Audio();
    let currentRotation = 0;
    let animationFrameId = null;
    let repeatMode = 0; // 0: none, 1: all, 2: one
    let songForAction = null; // Przechowuje utwór do operacji (dodaj/usuń)

    // --- Nowa struktura danych dla playlist ---
    let allSongs = []; // Główna lista wszystkich obiektów piosenek
    let playlists = {}; // { "nazwa": [url1, url2], ... }
    let playlistMetadata = {}; // { "nazwa": { cover: "base64..." } }
    let activePlaylistName = 'Wszystkie utwory';
    let songs = []; // Widok piosenek dla aktywnej playlisty

    // --- Przełączanie i zapamiętywanie motywu ---
    function applyTheme(theme) {
        // Domyślnie jest motyw standardowy (bez dodatkowej klasy)
        if (theme === 'vampire') {
            body.classList.add('theme-vampire');
        } else {
            body.classList.remove('theme-vampire');
        }
    }

    themeSwitcher.addEventListener('click', () => {
        body.classList.toggle('theme-vampire');
        const newTheme = body.classList.contains('theme-vampire') ? 'vampire' : 'default';
        localStorage.setItem('musicPlayerTheme', newTheme);
    });
    // Zastosuj motyw zapisany w pamięci przy starcie aplikacji
    applyTheme(localStorage.getItem('musicPlayerTheme'));

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        let secs = Math.floor(seconds % 60);
        if (secs < 10) {
            secs = '0' + secs;
        }
        return `${minutes}:${secs}`;
    }

    // --- Zarządzanie playlistami ---
    function loadPlaylists() {
        const storedPlaylists = localStorage.getItem('bubify_playlists');
        if (storedPlaylists) {
            playlists = JSON.parse(storedPlaylists);
        } else {
            playlists = { 'Ulubione': [] };
        }
        
        const storedMetadata = localStorage.getItem('bubify_playlist_metadata');
        if (storedMetadata) {
            playlistMetadata = JSON.parse(storedMetadata);
        } else {
            playlistMetadata = {};
        }

        // 'Wszystkie utwory' jest efemeryczna i zawsze tworzona od nowa
        playlists['Wszystkie utwory'] = [];
    }

    function savePlaylists() {
        const playlistsToSave = { ...playlists };
        // Nie zapisujemy auto-generowanej playlisty
        delete playlistsToSave['Wszystkie utwory'];
        localStorage.setItem('bubify_playlists', JSON.stringify(playlistsToSave));
    }

    function savePlaylistMetadata() {
        localStorage.setItem('bubify_playlist_metadata', JSON.stringify(playlistMetadata));
    }

    function togglePlaylistManager() {
        body.classList.toggle('playlist-manager-open');
    }

    function createPlaylist() {
        const name = prompt('Wprowadź nazwę nowej playlisty:');
        if (name && name.trim() !== '') {
            const trimmedName = name.trim();
            if (playlists[trimmedName]) {
                alert('Playlista o tej nazwie już istnieje!');
            } else {
                playlists[trimmedName] = [];
                savePlaylists();
                populatePlaylistManager();
            }
        }
    }

    function deletePlaylist(name) {
        if (confirm(`Czy na pewno chcesz usunąć playlistę "${name}"? Tej operacji nie można cofnąć.`)) {
            if (activePlaylistName === name) {
                setActivePlaylist('Wszystkie utwory');
            }
            delete playlists[name];
            delete playlistMetadata[name]; // Usuń też okładkę
            savePlaylists();
            populatePlaylistManager();
        }
    }

    function populatePlaylistManager() {
        playlistManagerList.innerHTML = '';
        Object.keys(playlists).forEach(name => {
            const li = document.createElement('li');
            li.classList.add('playlist-manager-item');
            
            // Dodaj miniaturkę okładki
            const img = document.createElement('img');
            img.classList.add('playlist-manager-cover');
            if (playlistMetadata[name] && playlistMetadata[name].cover) {
                img.src = playlistMetadata[name].cover;
            } else {
                const letter = name.charAt(0).toUpperCase();
                img.src = `https://placehold.co/60x60/333/999?text=${letter}`;
            }
            li.appendChild(img);

            const nameSpan = document.createElement('span');
            nameSpan.textContent = name;
            nameSpan.style.flexGrow = '1'; // Wypchnij przycisk usuwania na prawo
            li.appendChild(nameSpan);

            if (name === activePlaylistName) li.classList.add('active');

            // Dodaj przycisk usuwania dla playlist, które można usunąć
            if (name !== 'Wszystkie utwory' && name !== 'Ulubione') {
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-playlist-btn');
                deleteBtn.title = `Usuń playlistę "${name}"`;
                deleteBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Zapobiegaj przełączeniu playlisty po kliknięciu usuń
                    deletePlaylist(name);
                });
                li.appendChild(deleteBtn);
            }

            li.addEventListener('click', () => {
                setActivePlaylist(name);
                togglePlaylistManager();
            });
            playlistManagerList.appendChild(li);
        });
    }

    // --- Zarządzanie dodawaniem/usuwaniem utworów ---
    function openAddToPlaylistView(song) {
        songForAction = song;
        addToPlaylistTitle.textContent = `Dodaj "${song.title}" do...`;
        populateAddToPlaylistView();
        body.classList.add('add-to-playlist-open');
    }

    function closeAddToPlaylistView() {
        body.classList.remove('add-to-playlist-open');
    }

    function populateAddToPlaylistView() {
        addToPlaylistList.innerHTML = '';

        // Opcja usunięcia, jeśli jesteśmy na customowej playliście
        if (activePlaylistName !== 'Wszystkie utwory' && activePlaylistName !== 'Ulubione') {
            const removeItem = document.createElement('li');
            removeItem.classList.add('add-to-playlist-item', 'remove-item');
            removeItem.textContent = `Usuń z playlisty "${activePlaylistName}"`;
            removeItem.addEventListener('click', removeSongFromCurrentPlaylist);
            addToPlaylistList.appendChild(removeItem);
        }

        // Lista playlist do których można dodać utwór
        Object.keys(playlists)
            .filter(name => name !== 'Wszystkie utwory')
            .forEach(name => {
                const li = document.createElement('li');
                li.classList.add('add-to-playlist-item');
                li.textContent = name;
                li.addEventListener('click', () => addSongToPlaylist(name));
                addToPlaylistList.appendChild(li);
            });
    }

    function addSongToPlaylist(playlistName) {
        if (!songForAction || !playlists[playlistName]) return;

        const songUrl = songForAction.audio;
        if (!playlists[playlistName].includes(songUrl)) {
            playlists[playlistName].push(songUrl);
            savePlaylists();
        }
        // Można dodać powiadomienie "Dodano!"
        closeAddToPlaylistView();
    }

    function removeSongFromCurrentPlaylist() {
        if (!songForAction || activePlaylistName === 'Wszystkie utwory' || activePlaylistName === 'Ulubione') return;

        const songUrl = songForAction.audio;
        const index = playlists[activePlaylistName].indexOf(songUrl);
        if (index > -1) {
            playlists[activePlaylistName].splice(index, 1);
            savePlaylists();
            setActivePlaylist(activePlaylistName); // Odśwież widok
        }
        closeAddToPlaylistView();
    }

    // Pobranie mp3 z repozytorium GitHub
    loadPlaylists();
    fetch('https://api.github.com/repos/bearsleeping/Muzyka/contents/')
      .then(res => res.json())
      .then(files => {
          allSongs = files
              .filter(f => f.name.endsWith('.mp3'))
              .map(f => {
                  const name = f.name.replace(/\.mp3$/, '');
                  const parts = name.split(' - ');
                  const artist = parts.length > 1 ? parts[0].trim() : 'Nieznany artysta';
                  const title = parts.length > 1 ? parts[1].trim() : name;
                  
                  return {
                      title: title,
                      artist: artist,
                      duration: '0:00',
                      cover: 'https://placehold.co/100x100/2c2c2e/ffffff?text=?', // Placeholder
                      audio: f.download_url
                  };
              });
          
          // Wypełnij playlistę "Wszystkie utwory"
          playlists['Wszystkie utwory'] = allSongs.map(s => s.audio);

          // Ustaw aktywną playlistę (ostatnio używaną lub domyślną)
          const lastActivePlaylist = localStorage.getItem('bubify_lastActivePlaylist') || 'Wszystkie utwory';
          setActivePlaylist(playlists[lastActivePlaylist] ? lastActivePlaylist : 'Wszystkie utwory');

          fetchAlbumCovers(); // Pobierz okładki w tle
      })
      .catch(err => console.error("Błąd podczas pobierania listy utworów:", err));

    // --- Obsługa okładek playlist ---
    function resizeAndSaveCover(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxSize = 300; // Ograniczenie rozmiaru do 300px
                let width = img.width;
                let height = img.height;
                
                // Skalowanie z zachowaniem proporcji
                if (width > height) {
                    if (width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // Kompresja do JPEG 70% jakości
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                
                if (!playlistMetadata[activePlaylistName]) playlistMetadata[activePlaylistName] = {};
                playlistMetadata[activePlaylistName].cover = dataUrl;
                savePlaylistMetadata();
                playlistCoverImg.src = dataUrl;
                populatePlaylistManager(); // Odśwież listę playlist, aby pokazać nową okładkę
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }

    function setActivePlaylist(name) {
        if (!playlists[name]) {
            console.error(`Playlista "${name}" nie istnieje.`);
            return;
        }
        activePlaylistName = name;
        searchInput.value = ''; // Wyczyść wyszukiwarkę przy zmianie playlisty
        
        // Generuj tablicę `songs` dla aktywnej playlisty
        const songUrls = playlists[activePlaylistName];
        songs = songUrls.map(url => allSongs.find(s => s.audio === url)).filter(Boolean);

        playlistTitleEl.textContent = activePlaylistName;
        
        // Ustawianie okładki playlisty
        if (playlistMetadata[name] && playlistMetadata[name].cover) {
            playlistCoverImg.src = playlistMetadata[name].cover;
        } else {
            // Domyślna okładka (placeholder z pierwszą literą)
            const letter = name.charAt(0).toUpperCase();
            playlistCoverImg.src = `https://placehold.co/300x300/333/999?text=${letter}`;
        }

        // Pokaż/ukryj możliwość edycji okładki (tylko dla własnych playlist)
        if (name !== 'Wszystkie utwory') {
            playlistCoverOverlay.style.display = 'flex';
            playlistCoverOverlay.onclick = () => playlistCoverInput.click();
        } else {
            playlistCoverOverlay.style.display = 'none';
            playlistCoverOverlay.onclick = null;
        }
        
        // Pokaż/ukryj przycisk edycji
        if (name !== 'Wszystkie utwory') {
            editPlaylistBtn.style.display = 'flex';
        } else {
            editPlaylistBtn.style.display = 'none';
        }

        populatePlaylist();
        populatePlaylistManager();

        if (songs.length > 0) {
            loadSong(0);
        } else {
            // Wyczyść interfejs, jeśli playlista jest pusta
            document.querySelector('.song-title').textContent = 'Playlista jest pusta';
            document.querySelector('.song-artist').textContent = '...';
            document.querySelector('.album-cover img').src = 'https://placehold.co/100x100/2c2c2e/ffffff?text=?';
            durationEl.textContent = '0:00';
            currentTimeEl.textContent = '0:00';
            progress.style.width = '0%';
            audio.src = '';
            if (isPlaying) pauseSong();
        }
        localStorage.setItem('bubify_lastActivePlaylist', name);
    }

    function populatePlaylist() {
        songListEl.innerHTML = '';
        const favoriteUrls = new Set(playlists['Ulubione']);

        songs.forEach((song, index) => {
            const li = document.createElement('li');
            li.classList.add('song-item');
            li.setAttribute('draggable', 'true');
            li.dataset.index = index;
            const isFavorite = favoriteUrls.has(song.audio);

            li.innerHTML = `
                <div class="song-number">${index + 1}</div>
                <div class="song-thumbnail"><img src="${song.cover}" alt="Okładka"></div>
                <div class="song-item-info">
                    <div class="song-item-title">${song.title}</div>
                    <div class="song-item-artist">${song.artist}</div>
                </div>
                <div class="song-item-duration">${song.duration}</div>
                <div class="song-item-actions">
                    <button class="favorite-btn ${isFavorite ? 'is-favorite' : ''}">
                        <svg class="icon-heart-empty" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <svg class="icon-heart-filled" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    </button>
                    <button class="more-options-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    </button>
                </div>
            `;
            li.querySelector('.song-item-info').addEventListener('click', () => {
                currentSongIndex = index;
                loadSong(currentSongIndex);
                playSong();
                body.classList.remove('queue-open'); // Dodatkowo zamyka kolejkę po wyborze utworu
                queueBtn.classList.remove('active');
            });
            li.querySelector('.favorite-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(song);
            });
            li.querySelector('.more-options-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                openAddToPlaylistView(song);
            });
            addDragAndDropListeners(li);
            songListEl.appendChild(li);
        });
    }

    function loadSong(index) {
        if (!songs[index]) return;
        const song = songs[index];
        document.querySelector('.song-title').textContent = song.title;
        document.querySelector('.song-artist').textContent = song.artist;
        document.querySelector('.album-cover img').src = song.cover;
        durationEl.textContent = song.duration;

        audio.src = song.audio;

        // Sprawdzenie artysty i dodanie/usunięcie klasy dla cienia
        albumCover.classList.remove('type-o-negative-glow', 'rammstein-glow');
        
        const artistLower = song.artist.toLowerCase();
        if (artistLower.includes('type o negative')) {
            albumCover.classList.add('type-o-negative-glow');
        } else if (artistLower.includes('rammstein')) {
            albumCover.classList.add('rammstein-glow');
        }

        document.querySelectorAll('.song-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.song-item:nth-child(${index + 1})`)?.classList.add('active');

        // Aktualizacja stanu przycisku ulubionych w głównym odtwarzaczu
        if (playlists['Ulubione'].includes(song.audio)) {
            favoritePlayerBtn.classList.add('is-favorite');
        } else {
            favoritePlayerBtn.classList.remove('is-favorite');
        }

        // Zresetuj i potencjalnie rozpocznij animację obrotu dla nowego utworu
        cancelAnimationFrame(animationFrameId);
        currentRotation = 0;
        albumCover.style.transform = 'rotate(0deg)';
        if (isPlaying) {
            animationFrameId = requestAnimationFrame(rotateCover);
        }

        // Aktualizacja metadanych dla Media Session API - Chodzi o okładkę na panelu powiadomień
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: song.title,
                artist: song.artist,
                album: 'Bubify',
                artwork: [
                    { src: song.cover, sizes: '96x96', type: 'image/jpeg' },
                    { src: song.cover, sizes: '512x512', type: 'image/jpeg' },
                ]
            });
        }
    }

    function togglePlay() {
        if(isPlaying) pauseSong(); else playSong();
    }

    function playSong() {
        if(!audio.src) return;
        isPlaying = true;
        body.classList.add('playing'); // Ta klasa kontroluje teraz widoczność ikony
        cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(rotateCover);
        audio.play();
        if ('mediaSession' in navigator) {
            navigator.mediaSession.playbackState = "playing";
        }
    }

    function pauseSong() {
        isPlaying = false;
        body.classList.remove('playing');
        cancelAnimationFrame(animationFrameId);
        audio.pause();
        if ('mediaSession' in navigator) {
            navigator.mediaSession.playbackState = "paused";
        }
    }

    function nextSong() {
        if (songs.length === 0) return;
        currentSongIndex = (currentSongIndex + 1) % songs.length;
        loadSong(currentSongIndex);
        if (isPlaying) playSong();
    }

    function prevSong() {
        if (songs.length === 0) return;
        currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
        loadSong(currentSongIndex);
        if(isPlaying) playSong();
    }

    function fetchAlbumCovers() {
        allSongs.forEach((song, index) => {
            if (song.artist === 'Nieznany artysta') return;

            const searchTerm = encodeURIComponent(`${song.artist} ${song.title}`);
            const url = `https://itunes.apple.com/search?term=${searchTerm}&entity=song&limit=1`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const coverUrl = data.results[0].artworkUrl100.replace('100x100', '600x600');
                        allSongs[index].cover = coverUrl;

                        if (index === currentSongIndex) {
                            document.querySelector('.album-cover img').src = coverUrl;
                            // Zaktualizuj również okładkę w Media Session
                            if ('mediaSession' in navigator && navigator.mediaSession.metadata) {
                                navigator.mediaSession.metadata.artwork = [
                                    { src: coverUrl, sizes: '96x96', type: 'image/jpeg' },
                                    { src: coverUrl, sizes: '512x512', type: 'image/jpeg' },
                                ];
                            }
                        }
                        const songItem = songListEl.querySelector(`.song-item:nth-child(${index + 1})`);
                        if (songItem) {
                            songItem.querySelector('.song-thumbnail img').src = coverUrl;
                        }
                    }
                })
                .catch(err => console.warn(`Nie udało się pobrać okładki dla: ${song.title}`, err));
        });
    }

    function toggleFavorite(songToToggle) {
        const favoritePlaylist = playlists['Ulubione'];
        const songUrl = songToToggle.audio;
        const songIndexInFavorites = favoritePlaylist.indexOf(songUrl);

        if (songIndexInFavorites > -1) {
            favoritePlaylist.splice(songIndexInFavorites, 1);
        } else {
            favoritePlaylist.push(songUrl);
        }

        // Aktualizuj przycisk w głównym odtwarzaczu, jeśli zmieniamy aktualnie graną piosenkę
        if (songs[currentSongIndex] && songs[currentSongIndex].audio === songUrl) {
            favoritePlayerBtn.classList.toggle('is-favorite');
        }
        
        savePlaylists();
        // Odśwież widok, aby zaktualizować serduszka
        if (activePlaylistName === 'Ulubione') {
            setActivePlaylist('Ulubione'); // Pełne odświeżenie, jeśli jesteśmy na liście ulubionych
        } else {
            populatePlaylist(); // Tylko odświeżenie serduszek w bieżącym widoku
        }
    }

    function toggleQueue() {
        body.classList.toggle('queue-open');
        queueBtn.classList.toggle('active');
    }

    function cycleRepeatMode() {
        repeatMode = (repeatMode + 1) % 3;
        updateRepeatUI();
    }

    function updateRepeatUI() {
        if (repeatMode === 0) { // None
            repeatBtn.classList.remove('active');
            iconRepeatAll.style.display = 'block';
            iconRepeatOne.style.display = 'none';
        } else if (repeatMode === 1) { // All
            repeatBtn.classList.add('active');
            iconRepeatAll.style.display = 'block';
            iconRepeatOne.style.display = 'none';
        } else { // One (repeatMode === 2)
            iconRepeatAll.style.display = 'none';
            iconRepeatOne.style.display = 'block';
        }
    }

    function rotateCover() {
        if (!isPlaying) return;
        currentRotation += 0.1; // Dostosuj prędkość obrotu
        albumCover.style.transform = `rotate(${currentRotation}deg)`;
        animationFrameId = requestAnimationFrame(rotateCover);
    }

    function updateVolumeSlider() {
        const percentage = (volumeSlider.value - volumeSlider.min) / (volumeSlider.max - volumeSlider.min) * 100;
        volumeSlider.style.setProperty('--volume-progress', `${percentage}%`);
    }

    // --- Funkcjonalność przewijania (skreczowania) na desktop i mobile ---
    let isScrubbing = false;
    let wasPlayingBeforeScrub = false;
    let albumCoverCenterX, albumCoverCenterY;
    let lastAngle = 0;

    function handleScrubStart(e) {
        if (!audio.duration) return;
        e.preventDefault(); // Zapobiega domyślnym akcjom, np. zaznaczaniu tekstu lub przewijaniu strony na mobile

        isScrubbing = true;
        wasPlayingBeforeScrub = isPlaying;
        if (wasPlayingBeforeScrub) {
            pauseSong();
        }

        // Oblicz środek okładki
        const rect = albumCover.getBoundingClientRect();
        albumCoverCenterX = rect.left + rect.width / 2;
        albumCoverCenterY = rect.top + rect.height / 2;

        // Pobierz pozycję wskaźnika (mysz lub dotyk)
        const pointerX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        const pointerY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

        // Ustaw kąt początkowy do obliczania różnicy w ruchu
        lastAngle = Math.atan2(pointerY - albumCoverCenterY, pointerX - albumCoverCenterX);

        body.classList.add('scrubbing');
        progress.style.transition = 'none'; // Wyłącz płynną animację paska postępu dla natychmiastowej reakcji
    }

    function handleScrubMove(e) {
        if (!isScrubbing) return;
        e.preventDefault();

        const pointerX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const pointerY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

        const currentAngle = Math.atan2(pointerY - albumCoverCenterY, pointerX - albumCoverCenterX);
        let deltaAngle = currentAngle - lastAngle;

        // Poprawka na "przeskakiwanie" kąta z +180 na -180 stopni i odwrotnie
        if (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
        if (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

        const deltaAngleDeg = deltaAngle * (180 / Math.PI);

        // Zaktualizuj obrót wizualny, dodając zmianę
        currentRotation += deltaAngleDeg;
        albumCover.style.transform = `rotate(${currentRotation}deg)`;

        // Zaktualizuj czas utworu na podstawie zmiany kąta
        const timePerDegree = 15 / 360; // Czułość: 15 sekund utworu na pełny obrót (360 stopni)
        const timeChange = deltaAngleDeg * timePerDegree;
        let newTime = audio.currentTime + timeChange;
        if (newTime < 0) newTime = 0;
        if (newTime > audio.duration) newTime = audio.duration;
        audio.currentTime = newTime;

        // Zapisz aktualny kąt na potrzeby następnego ruchu
        lastAngle = currentAngle;
    }

    function handleScrubEnd() {
        if (!isScrubbing) return;
        isScrubbing = false;
        body.classList.remove('scrubbing');
        progress.style.transition = 'width 0.1s linear'; // Włącz ponownie animację paska
        if (wasPlayingBeforeScrub) playSong();
    }

    // --- Funkcjonalność przewijania (skreczowania) na PASKU POSTĘPU ---
    let isProgressScrubbing = false;

    function setSongPosition(e) {
        if (!audio.duration) return;
        const rect = progressBar.getBoundingClientRect();
        // Dla zdarzeń dotykowych użyj pierwszego punktu dotyku
        const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
        const offsetX = clientX - rect.left;
        const width = rect.width;
        let newTime = (offsetX / width) * audio.duration;

        // Ogranicz wartość do zakresu od 0 do czasu trwania utworu
        if (newTime < 0) newTime = 0;
        if (newTime > audio.duration) newTime = audio.duration;

        audio.currentTime = newTime;
    }

    function handleProgressScrubStart(e) {
        e.preventDefault();
        isProgressScrubbing = true;
        progress.style.transition = 'none'; // Wyłącz płynną animację dla natychmiastowej reakcji
        body.classList.add('scrubbing');
        setSongPosition(e); // Ustaw pozycję od razu po kliknięciu
    }

    function handleProgressScrubMove(e) {
        if (!isProgressScrubbing) return;
        e.preventDefault();
        setSongPosition(e);
    }

    function handleProgressScrubEnd() {
        if (!isProgressScrubbing) return;
        isProgressScrubbing = false;
        progress.style.transition = 'width 0.1s linear'; // Włącz ponownie animację paska
        body.classList.remove('scrubbing');
    }

    // Dodanie nasłuchiwaczy dla paska postępu (zastępuje stary 'click')
    progressBar.addEventListener('mousedown', handleProgressScrubStart);
    progressBar.addEventListener('touchstart', handleProgressScrubStart, { passive: false });

    // Nasłuchiwacze na całym dokumencie, aby przeciąganie działało płynnie
    document.addEventListener('mousemove', handleProgressScrubMove);
    document.addEventListener('touchmove', handleProgressScrubMove, { passive: false });

    document.addEventListener('mouseup', handleProgressScrubEnd);
    document.addEventListener('touchend', handleProgressScrubEnd);

    audio.addEventListener('timeupdate', () => {
        if(!audio.duration) return;
        const progressPercent = (audio.currentTime/audio.duration)*100;
        progress.style.width = `${progressPercent}%`;

        currentTimeEl.textContent = formatTime(audio.currentTime);
    });

    audio.addEventListener('loadedmetadata', () => {
        if (audio.duration) {
            const formattedDuration = formatTime(audio.duration);
            durationEl.textContent = formattedDuration;
            
            if (songs[currentSongIndex]) {
                songs[currentSongIndex].duration = formattedDuration;
                const songItem = songListEl.querySelector(`.song-item:nth-child(${currentSongIndex + 1})`);
                if (songItem) songItem.querySelector('.song-item-duration').textContent = formattedDuration;
            }
        }
    });

    audio.addEventListener('ended', () => {
        if (repeatMode === 2) { // Powtarzaj jeden
            audio.currentTime = 0;
            playSong();
        } else if (repeatMode === 1) { // Powtarzaj wszystko
            nextSong();
        } else { // Bez powtarzania
            if (currentSongIndex < songs.length - 1) {
                nextSong();
            } else {
                // Koniec listy, zatrzymaj odtwarzanie
                pauseSong();
                audio.currentTime = 0;
            }
        }
    });
    playBtn.addEventListener('click', togglePlay);
    document.querySelector('.prev-btn').addEventListener('click', prevSong);
    document.querySelector('.next-btn').addEventListener('click', nextSong);
    queueBtn.addEventListener('click', toggleQueue);
    repeatBtn.addEventListener('click', cycleRepeatMode);
    managePlaylistsBtn.addEventListener('click', togglePlaylistManager);
    closePlaylistManagerBtn.addEventListener('click', togglePlaylistManager);
    createPlaylistBtn.addEventListener('click', createPlaylist);
    closeAddToPlaylistBtn.addEventListener('click', closeAddToPlaylistView);
    favoritePlayerBtn.addEventListener('click', () => {
        if (songs[currentSongIndex]) toggleFavorite(songs[currentSongIndex]);
    });
    
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const items = songListEl.querySelectorAll('.song-item');
        items.forEach(item => {
            const title = item.querySelector('.song-item-title').textContent.toLowerCase();
            const artist = item.querySelector('.song-item-artist').textContent.toLowerCase();
            if (title.includes(term) || artist.includes(term)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });

    playlistCoverInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            resizeAndSaveCover(e.target.files[0]);
        }
    });

    // --- Obsługa modala edycji playlisty ---
    let tempCoverDataUrl = null;

    editPlaylistBtn.addEventListener('click', () => {
        editModalNameInput.value = activePlaylistName;
        if (activePlaylistName === 'Ulubione') {
            editModalNameInput.disabled = true;
            editModalNameInput.title = "Nie można zmienić nazwy playlisty systemowej";
        } else {
            editModalNameInput.disabled = false;
            editModalNameInput.title = "";
        }
        
        if (playlistMetadata[activePlaylistName] && playlistMetadata[activePlaylistName].cover) {
            editModalCoverImg.src = playlistMetadata[activePlaylistName].cover;
        } else {
            const letter = activePlaylistName.charAt(0).toUpperCase();
            editModalCoverImg.src = `https://placehold.co/300x300/333/999?text=${letter}`;
        }
        tempCoverDataUrl = null;
        editPlaylistModal.classList.add('open');
    });

    function closeEditModal() {
        editPlaylistModal.classList.remove('open');
    }

    editModalCancelBtn.addEventListener('click', closeEditModal);
    editModalCoverWrapper.addEventListener('click', () => editModalFileInput.click());

    editModalFileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxSize = 300;
                    let width = img.width;
                    let height = img.height;
                    if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } }
                    else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    tempCoverDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    editModalCoverImg.src = tempCoverDataUrl;
                }
                img.src = ev.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    editModalSaveBtn.addEventListener('click', () => {
        const newName = editModalNameInput.value.trim();
        if (!newName) return alert("Nazwa nie może być pusta");
        
        // Zmiana nazwy
        if (newName !== activePlaylistName && activePlaylistName !== 'Ulubione') {
            if (playlists[newName]) return alert("Playlista o tej nazwie już istnieje");
            
            // Kopiowanie danych
            playlists[newName] = playlists[activePlaylistName];
            if (playlistMetadata[activePlaylistName]) {
                playlistMetadata[newName] = playlistMetadata[activePlaylistName];
            }
            
            // Usuwanie starej playlisty
            delete playlists[activePlaylistName];
            delete playlistMetadata[activePlaylistName];
            
            activePlaylistName = newName;
        }

        // Aktualizacja okładki
        if (tempCoverDataUrl) {
            if (!playlistMetadata[activePlaylistName]) playlistMetadata[activePlaylistName] = {};
            playlistMetadata[activePlaylistName].cover = tempCoverDataUrl;
        }

        savePlaylists();
        savePlaylistMetadata();
        setActivePlaylist(activePlaylistName); // Odśwież widok
        closeEditModal();
    });

    // --- Drag & Drop Logic ---
    let dragStartIndex;

    function addDragAndDropListeners(item) {
        item.addEventListener('dragstart', dragStart);
        item.addEventListener('dragover', dragOver);
        item.addEventListener('drop', dragDrop);
        item.addEventListener('dragenter', dragEnter);
        item.addEventListener('dragleave', dragLeave);
        item.addEventListener('dragend', dragEnd);
    }

    function dragStart() {
        dragStartIndex = +this.dataset.index;
        this.classList.add('dragging');
    }

    function dragEnter(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    }

    function dragLeave(e) {
        // Usuń klasę tylko jeśli kursor wychodzi poza element (a nie wchodzi w jego dziecko)
        if (!this.contains(e.relatedTarget)) {
            this.classList.remove('drag-over');
        }
    }

    function dragOver(e) {
        e.preventDefault();
    }

    function dragDrop() {
        const dragEndIndex = +this.dataset.index;
        swapItems(dragStartIndex, dragEndIndex);
        this.classList.remove('drag-over');
    }
    
    function dragEnd() {
        this.classList.remove('dragging');
        document.querySelectorAll('.song-item').forEach(item => item.classList.remove('drag-over'));
    }

    function swapItems(fromIndex, toIndex) {
        if (fromIndex === toIndex) return;
        
        const playlist = playlists[activePlaylistName];
        const itemToMove = playlist.splice(fromIndex, 1)[0];
        playlist.splice(toIndex, 0, itemToMove);
        
        if (activePlaylistName !== 'Wszystkie utwory') {
            savePlaylists();
        }
        
        // Odśwież widok zachowując stan odtwarzacza
        // Musimy ręcznie zaktualizować tablicę songs i currentSongIndex
        const currentSongUrl = songs[currentSongIndex] ? songs[currentSongIndex].audio : null;
        const songUrls = playlists[activePlaylistName];
        songs = songUrls.map(url => allSongs.find(s => s.audio === url)).filter(Boolean);

        if (currentSongUrl) {
            const newIndex = songs.findIndex(s => s.audio === currentSongUrl);
            if (newIndex !== -1) currentSongIndex = newIndex;
        }

        populatePlaylist();
        
        // Przywróć podświetlenie aktywnego utworu
        if (songs[currentSongIndex]) {
             document.querySelectorAll('.song-item').forEach(item => item.classList.remove('active'));
             document.querySelector(`.song-item:nth-child(${currentSongIndex + 1})`)?.classList.add('active');
        }
    }

    volumeSlider.addEventListener('input', (e) => {
        audio.volume = e.target.value / 100;
        updateVolumeSlider();
    });
    audio.volume = volumeSlider.value / 100;
    updateVolumeSlider();

    // Nasłuchiwanie na zdarzenia myszy i dotyku dla okładki
    albumCover.addEventListener('mousedown', handleScrubStart);
    albumCover.addEventListener('touchstart', handleScrubStart, { passive: false });

    // Nasłuchiwanie na całym dokumencie, aby przeciąganie działało nawet po wyjechaniu kursorem/palcem poza okładkę
    document.addEventListener('mousemove', handleScrubMove);
    document.addEventListener('touchmove', handleScrubMove, { passive: false });

    document.addEventListener('mouseup', handleScrubEnd);
    document.addEventListener('touchend', handleScrubEnd);

    // Integracja z Media Session API (sterowanie z belki systemowej / ekranu blokady)
    if ('mediaSession' in navigator) {
        navigator.mediaSession.setActionHandler('play', playSong);
        navigator.mediaSession.setActionHandler('pause', pauseSong);
        navigator.mediaSession.setActionHandler('previoustrack', prevSong);
        navigator.mediaSession.setActionHandler('nexttrack', nextSong);
    }

});
</script>
</body>
</html>
