<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Bubfiy</title>

<!-- Ustawienia dla aplikacji webowej na iOS (ukrycie paska przeglądarki) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Bubify">
<link rel="apple-touch-icon" href="images/apple-touch-icon.png"> <!-- Zastąp ścieżką do Twojej ikony (np. 180x180px) -->

<style>
:root {
    --bg-color: #1c1c1e;
    --primary: #0a84ff;
    --text-primary: #ffffff;
    --text-secondary: #98989d;
    --control-bg: #3a3a3c;
    --card-bg: #2c2c2e;
}
* { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
body { background-color: var(--bg-color); color: var(--text-primary); max-width:400px; margin:0 auto; height:100vh; display:flex; flex-direction:column; overflow:hidden; position:relative; transition: transform 0.3s ease-in-out; }
.header { padding:15px; text-align:center; font-size:18px; font-weight:600; letter-spacing:-0.5px; }
.now-playing { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:0 30px; transition: transform 0.3s ease-in-out; }
.album-cover { width:280px; height:280px; border-radius:50%; box-shadow:0 4px 30px rgba(0,0,0,0.5); position:relative; margin-bottom:30px; background:#1a1a1a; display:flex; align-items:center; justify-content:center; background-image: repeating-radial-gradient(circle at center, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 4px); cursor: grab; }
.album-cover::before { content:''; position:absolute; width:20px; height:20px; background:var(--bg-color); border-radius:50%; z-index:2; border:3px solid #333; }
.album-cover img { width:130px; height:130px; object-fit:cover; border-radius:50%; z-index:1; }
.song-info { text-align:center; margin-bottom:30px; width:100%; }
.song-title { font-size:22px; font-weight:600; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.song-artist { font-size:16px; color:var(--text-secondary); }
.progress-container { width:100%; margin-bottom:15px; }
.progress-bar { width:100%; height:3px; background-color:var(--control-bg); border-radius:3px; margin-bottom:5px; cursor:pointer; }
.progress { height:100%; background-color:var(--primary); border-radius:3px; width:0%; transition: width 0.1s linear; }
.time { display:flex; justify-content:space-between; font-size:12px; color:var(--text-secondary); }
.volume-container {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 25px;
}
.volume-container svg {
    fill: var(--text-secondary);
    flex-shrink: 0;
}
.volume-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 24px; /* Zwiększona wysokość dla łatwiejszej interakcji na dotyku */
    background: transparent; /* Tło jest teraz na ścieżce */
    outline: none;
    cursor: pointer;
}
.volume-slider::-webkit-slider-runnable-track {
    width: 100%;
    height: 4px;
    cursor: pointer;
    background: linear-gradient(to right, var(--text-primary) var(--volume-progress, 100%), var(--control-bg) var(--volume-progress, 100%));
    border-radius: 4px;
}
.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    height: 16px;
    width: 0; /* Ukrycie kciuka */
    border-radius: 50%;
    background: transparent;
    cursor: pointer;
    margin-top: -6px; /* Wyśrodkowanie kciuka na ścieżce */
}

/* Style dla Firefox */
.volume-slider::-moz-range-track {
    width: 100%;
    height: 4px;
    cursor: pointer;
    background: var(--control-bg);
    border-radius: 4px;
}
.volume-slider::-moz-range-progress {
    background-color: var(--text-primary);
    height: 4px;
    border-radius: 4px;
}
.volume-slider::-moz-range-thumb {
    height: 16px;
    width: 0; /* Ukrycie kciuka */
    border-radius: 50%;
    background: transparent;
    cursor: pointer;
    border: none;
}
.controls { display:flex; justify-content:center; align-items:center; gap: 20px; margin-bottom:30px; }
.control-btn { width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%; cursor:pointer; background-color: rgba(255,255,255,0.1); transition: background-color 0.2s; }
.control-btn:hover { background-color: rgba(255,255,255,0.2); }
.control-btn svg { fill:white; }
.control-btn.active svg { fill: var(--primary); }
.play-btn { width:60px; height:60px; background-color: var(--primary); }
.play-btn:hover { background-color: #0066cc; }
.playing .play-btn .icon-play {
    display: none;
}
.playing .play-btn .icon-pause {
    display: block !important; /* Użyj important, aby nadpisać styl inline */
}
.player-footer { background-color:var(--card-bg); border-top-left-radius:15px; border-top-right-radius:15px; padding:0 20px 15px; box-shadow:0 -5px 15px rgba(0,0,0,0.3); position:absolute; bottom:0; left:0; right:0; transform: translateY(100%); transition: transform 0.3s ease-in-out; }
.song-list { list-style:none; max-height:500px; overflow-y:auto; padding-top: 15px; }
.song-item { display:flex; align-items:center; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer; transition:background-color 0.2s; }
.song-item:hover { background-color: rgba(255,255,255,0.05); }
.song-item:last-child { border-bottom:none; }
.song-number { color:var(--text-secondary); font-size:14px; width:30px; text-align:center; }
.song-thumbnail { width:40px; height:40px; border-radius:5px; overflow:hidden; margin-right:15px; }
.song-thumbnail img { width:100%; height:100%; object-fit:cover; }
.song-item-info { flex:1; }
.song-item-title { font-size:15px; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.song-item-artist { font-size:13px; color:var(--text-secondary); }
.song-item.active .song-item-title {
    color: var(--primary);
}
.song-item-duration { font-size:13px; color:var(--text-secondary); margin-left:15px; }
.song-list::-webkit-scrollbar { width:5px; }
.song-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius:10px; }
.song-list::-webkit-scrollbar-thumb { background:var(--text-secondary); border-radius:10px; }
@media (max-height:700px) { .album-cover { width:220px; height:220px; } }
.theme-toggle { position:absolute; top:15px; right:15px; width:30px; height:30px; border-radius:50%; background-color:var(--card-bg); display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:10; }
.theme-toggle svg { width:16px; height:16px; fill:var(--text-primary); }

/* Nowe style do animacji wysuwania kolejki */
body.queue-open .player-footer {
    transform: translateY(0);
}
body.queue-open .now-playing {
    transform: translateY(-450px);
}
body.scrubbing {
    cursor: grabbing;
}
</style>
</head>
<body>
<div class="theme-toggle" id="theme-toggle">
<svg viewBox="0 0 24 24"><path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1-8.313-12.454z"/></svg>
</div>
<div class="header"></div>
<div class="now-playing">
<div class="album-cover">
<img src="https://placehold.co/130x130/2c2c2e/ffffff?text=?" alt="Okładka albumu" />
</div>
<div class="song-info">
<div class="song-title">Ładowanie...</div>
<div class="song-artist">...</div>
</div>
<div class="progress-container">
<div class="progress-bar">
<div class="progress" id="progress"></div>
</div>
<div class="time">
<span id="current-time">0:00</span>
<span id="duration">0:00</span>
</div>
</div>
<div class="volume-container">
    <svg width="16" height="16" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
    <input type="range" id="volume-slider" class="volume-slider" min="0" max="100" value="100">
</div>
<div class="controls">
<div class="control-btn repeat-btn">
<svg width="20" height="20" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
</div>
<div class="control-btn prev-btn">
<svg width="15" height="15" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
</div>
<div class="control-btn play-btn" id="play-btn">
<svg class="icon-play" width="20" height="20" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
<svg class="icon-pause" width="20" height="20" viewBox="0 0 24 24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
</div>
<div class="control-btn next-btn">
<svg width="15" height="15" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
</div>
<div class="control-btn queue-btn">
<svg width="20" height="20" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
</div>
</div>
</div>
<div class="player-footer">
<ul class="song-list" id="song-list">
</ul>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const playBtn = document.getElementById('play-btn');
    const progress = document.getElementById('progress');
    const currentTimeEl = document.getElementById('current-time');
    const durationEl = document.getElementById('duration');
    const songListEl = document.getElementById('song-list');
    const queueBtn = document.querySelector('.queue-btn');
    const body = document.body;
    const volumeSlider = document.getElementById('volume-slider');
    const albumCover = document.querySelector('.album-cover');

    let isPlaying = false;
    let currentSongIndex = 0;
    let songs = [];
    const audio = new Audio();
    let currentRotation = 0;
    let animationFrameId = null;

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        let secs = Math.floor(seconds % 60);
        if (secs < 10) {
            secs = '0' + secs;
        }
        return `${minutes}:${secs}`;
    }

    // Pobranie mp3 z repozytorium GitHub
    fetch('https://api.github.com/repos/bearsleeping/Muzyka/contents/')
      .then(res => res.json())
      .then(files => {
          songs = files
              .filter(f => f.name.endsWith('.mp3'))
              .map(f => {
                  const name = f.name.replace(/\.mp3$/, '');
                  const parts = name.split(' - ');
                  const artist = parts.length > 1 ? parts[0].trim() : 'Nieznany artysta';
                  const title = parts.length > 1 ? parts[1].trim() : name;
                  
                  return {
                      title: title,
                      artist: artist,
                      duration: '0:00',
                      cover: 'https://placehold.co/130x130/2c2c2e/ffffff?text=?', // Placeholder
                      audio: f.download_url
                  };
              });
          populatePlaylist();
          loadSong(0);
          fetchAlbumCovers(); // Pobierz okładki w tle
          fetchSongDurations();
      })
      .catch(err => console.error("Błąd podczas pobierania listy utworów:", err));

    function populatePlaylist() {
        songListEl.innerHTML = '';
        songs.forEach((song, index) => {
            const li = document.createElement('li');
            li.classList.add('song-item');
            li.innerHTML = `
                <div class="song-number">${index + 1}</div>
                <div class="song-thumbnail"><img src="${song.cover}" alt="Okładka"></div>
                <div class="song-item-info">
                    <div class="song-item-title">${song.title}</div>
                    <div class="song-item-artist">${song.artist}</div>
                </div>
                <div class="song-item-duration">${song.duration}</div>
            `;
            li.addEventListener('click', () => {
                currentSongIndex = index;
                loadSong(currentSongIndex);
                playSong();
                body.classList.remove('queue-open'); // Dodatkowo zamyka kolejkę po wyborze utworu
                queueBtn.classList.remove('active');
            });
            songListEl.appendChild(li);
        });
    }

    function loadSong(index) {
        const song = songs[index];
        document.querySelector('.song-title').textContent = song.title;
        document.querySelector('.song-artist').textContent = song.artist;
        document.querySelector('.album-cover img').src = song.cover;
        durationEl.textContent = song.duration;
        audio.src = song.audio;

        document.querySelectorAll('.song-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.song-item:nth-child(${index + 1})`)?.classList.add('active');

        // Zresetuj i potencjalnie rozpocznij animację obrotu dla nowego utworu
        cancelAnimationFrame(animationFrameId);
        currentRotation = 0;
        albumCover.style.transform = 'rotate(0deg)';
        if (isPlaying) {
            animationFrameId = requestAnimationFrame(rotateCover);
        }

        // Aktualizacja metadanych dla Media Session API - Chodzi o okładkę na panelu powiadomień
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: song.title,
                artist: song.artist,
                album: 'Bubify',
                artwork: [
                    { src: song.cover, sizes: '96x96', type: 'image/jpeg' },
                    { src: song.cover, sizes: '512x512', type: 'image/jpeg' },
                ]
            });
        }
    }

    function togglePlay() {
        if(isPlaying) pauseSong(); else playSong();
    }

    function playSong() {
        if(!audio.src) return;
        isPlaying = true;
        body.classList.add('playing'); // Ta klasa kontroluje teraz widoczność ikony
        cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(rotateCover);
        audio.play();
        if ('mediaSession' in navigator) {
            navigator.mediaSession.playbackState = "playing";
        }
    }

    function pauseSong() {
        isPlaying = false;
        body.classList.remove('playing');
        cancelAnimationFrame(animationFrameId);
        audio.pause();
        if ('mediaSession' in navigator) {
            navigator.mediaSession.playbackState = "paused";
        }
    }

    function nextSong() {
        if(songs.length===0) return;
        currentSongIndex = (currentSongIndex+1)%songs.length;
        loadSong(currentSongIndex);
        if(isPlaying) playSong();
    }

    function prevSong() {
        if(songs.length===0) return;
        currentSongIndex = (currentSongIndex-1 + songs.length)%songs.length;
        loadSong(currentSongIndex);
        if(isPlaying) playSong();
    }

    function fetchAlbumCovers() {
        songs.forEach((song, index) => {
            if (song.artist === 'Nieznany artysta') return;

            const searchTerm = encodeURIComponent(`${song.artist} ${song.title}`);
            const url = `https://itunes.apple.com/search?term=${searchTerm}&entity=song&limit=1`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const coverUrl = data.results[0].artworkUrl100.replace('100x100', '600x600');
                        songs[index].cover = coverUrl;

                        if (index === currentSongIndex) {
                            document.querySelector('.album-cover img').src = coverUrl;
                            // Zaktualizuj również okładkę w Media Session
                            if ('mediaSession' in navigator && navigator.mediaSession.metadata) {
                                navigator.mediaSession.metadata.artwork = [
                                    { src: coverUrl, sizes: '96x96', type: 'image/jpeg' },
                                    { src: coverUrl, sizes: '512x512', type: 'image/jpeg' },
                                ];
                            }
                        }
                        const songItem = songListEl.querySelector(`.song-item:nth-child(${index + 1})`);
                        if (songItem) {
                            songItem.querySelector('.song-thumbnail img').src = coverUrl;
                        }
                    }
                })
                .catch(err => console.warn(`Nie udało się pobrać okładki dla: ${song.title}`, err));
        });
    }

    function fetchSongDurations() {
        songs.forEach((song, index) => {
            const tempAudio = new Audio();
            tempAudio.src = song.audio;
            tempAudio.addEventListener('loadedmetadata', () => {
                if (tempAudio.duration) {
                    const formattedDuration = formatTime(tempAudio.duration);
                    songs[index].duration = formattedDuration;
                    const songItem = songListEl.querySelector(`.song-item:nth-child(${index + 1})`);
                    if (songItem) {
                        songItem.querySelector('.song-item-duration').textContent = formattedDuration;
                    }
                }
            });
        });
    }

    function toggleQueue() {
        body.classList.toggle('queue-open');
        queueBtn.classList.toggle('active');
    }

    function rotateCover() {
        if (!isPlaying) return;
        currentRotation += 0.1; // Dostosuj prędkość obrotu
        albumCover.style.transform = `rotate(${currentRotation}deg)`;
        animationFrameId = requestAnimationFrame(rotateCover);
    }

    function updateVolumeSlider() {
        const percentage = (volumeSlider.value - volumeSlider.min) / (volumeSlider.max - volumeSlider.min) * 100;
        volumeSlider.style.setProperty('--volume-progress', `${percentage}%`);
    }

    // --- Funkcjonalność przewijania (skreczowania) na desktop i mobile ---
    let isScrubbing = false;
    let wasPlayingBeforeScrub = false;
    let albumCoverCenterX, albumCoverCenterY;
    let lastAngle = 0;

    function handleScrubStart(e) {
        if (!audio.duration) return;
        e.preventDefault(); // Zapobiega domyślnym akcjom, np. zaznaczaniu tekstu lub przewijaniu strony na mobile

        isScrubbing = true;
        wasPlayingBeforeScrub = isPlaying;
        if (wasPlayingBeforeScrub) {
            pauseSong();
        }

        // Oblicz środek okładki
        const rect = albumCover.getBoundingClientRect();
        albumCoverCenterX = rect.left + rect.width / 2;
        albumCoverCenterY = rect.top + rect.height / 2;

        // Pobierz pozycję wskaźnika (mysz lub dotyk)
        const pointerX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        const pointerY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

        // Ustaw kąt początkowy do obliczania różnicy w ruchu
        lastAngle = Math.atan2(pointerY - albumCoverCenterY, pointerX - albumCoverCenterX);

        body.classList.add('scrubbing');
        progress.style.transition = 'none'; // Wyłącz płynną animację paska postępu dla natychmiastowej reakcji
    }

    function handleScrubMove(e) {
        if (!isScrubbing) return;
        e.preventDefault();

        const pointerX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const pointerY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

        const currentAngle = Math.atan2(pointerY - albumCoverCenterY, pointerX - albumCoverCenterX);
        let deltaAngle = currentAngle - lastAngle;

        // Poprawka na "przeskakiwanie" kąta z +180 na -180 stopni i odwrotnie
        if (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
        if (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

        const deltaAngleDeg = deltaAngle * (180 / Math.PI);

        // Zaktualizuj obrót wizualny, dodając zmianę
        currentRotation += deltaAngleDeg;
        albumCover.style.transform = `rotate(${currentRotation}deg)`;

        // Zaktualizuj czas utworu na podstawie zmiany kąta
        const timePerDegree = 15 / 360; // Czułość: 15 sekund utworu na pełny obrót (360 stopni)
        const timeChange = deltaAngleDeg * timePerDegree;
        let newTime = audio.currentTime + timeChange;
        if (newTime < 0) newTime = 0;
        if (newTime > audio.duration) newTime = audio.duration;
        audio.currentTime = newTime;

        // Zapisz aktualny kąt na potrzeby następnego ruchu
        lastAngle = currentAngle;
    }

    function handleScrubEnd() {
        if (!isScrubbing) return;
        isScrubbing = false;
        body.classList.remove('scrubbing');
        progress.style.transition = 'width 0.1s linear'; // Włącz ponownie animację paska
        if (wasPlayingBeforeScrub) playSong();
    }

    audio.addEventListener('timeupdate', () => {
        if(!audio.duration) return;
        const progressPercent = (audio.currentTime/audio.duration)*100;
        progress.style.width = `${progressPercent}%`;

        currentTimeEl.textContent = formatTime(audio.currentTime);
    });

    audio.addEventListener('loadedmetadata', () => {
        if (audio.duration) {
            const formattedDuration = formatTime(audio.duration);
            durationEl.textContent = formattedDuration;
            
            if (songs[currentSongIndex]) {
                songs[currentSongIndex].duration = formattedDuration;
                const songItem = songListEl.querySelector(`.song-item:nth-child(${currentSongIndex + 1})`);
                if (songItem) songItem.querySelector('.song-item-duration').textContent = formattedDuration;
            }
        }
    });

    document.querySelector('.progress-bar').addEventListener('click', function(e){
        if(!audio.duration) return;
        const width = this.clientWidth;
        audio.currentTime = (e.offsetX/width)*audio.duration;
    });

    audio.addEventListener('ended', nextSong);
    playBtn.addEventListener('click', togglePlay);
    document.querySelector('.prev-btn').addEventListener('click', prevSong);
    document.querySelector('.next-btn').addEventListener('click', nextSong);
    queueBtn.addEventListener('click', toggleQueue);

    volumeSlider.addEventListener('input', (e) => {
        audio.volume = e.target.value / 100;
        updateVolumeSlider();
    });
    audio.volume = volumeSlider.value / 100;
    updateVolumeSlider();

    // Nasłuchiwanie na zdarzenia myszy i dotyku dla okładki
    albumCover.addEventListener('mousedown', handleScrubStart);
    albumCover.addEventListener('touchstart', handleScrubStart, { passive: false });

    // Nasłuchiwanie na całym dokumencie, aby przeciąganie działało nawet po wyjechaniu kursorem/palcem poza okładkę
    document.addEventListener('mousemove', handleScrubMove);
    document.addEventListener('touchmove', handleScrubMove, { passive: false });

    document.addEventListener('mouseup', handleScrubEnd);
    document.addEventListener('touchend', handleScrubEnd);

    // Integracja z Media Session API (sterowanie z belki systemowej / ekranu blokady)
    if ('mediaSession' in navigator) {
        navigator.mediaSession.setActionHandler('play', playSong);
        navigator.mediaSession.setActionHandler('pause', pauseSong);
        navigator.mediaSession.setActionHandler('previoustrack', prevSong);
        navigator.mediaSession.setActionHandler('nexttrack', nextSong);
    }

});
</script>
</body>
</html>
